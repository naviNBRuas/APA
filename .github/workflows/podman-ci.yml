name: Podman CI

# This workflow builds and runs the agent in a Podman container.
# The Go tests are run in the main CI workflow (ci.yml).

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ matrix.goarch == 'arm64' }}
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24' # Ensure Go is set up for building WASM
      - name: Build WASM modules
        run: |
          MODULES=(config-watcher crypto-hasher data-logger message-broker net-monitor simple-adder system-info)
          for module in "${MODULES[@]}"; do
            echo "Building WASM module: $module"
            GOOS=wasip1 GOARCH=wasm go build -o examples/modules/$module/$module.wasm examples/modules/$module/main.go
          done
      - name: Set up Podman
        run: sudo apt-get update && sudo apt-get install -y podman
      - name: Build APA image
        run: podman build --build-arg GOOS=linux --build-arg GOARCH=${{ matrix.goarch }} -t apa:ci-${{ matrix.goarch }} -f Containerfile .
      - name: Run APA container
        run: podman run --rm -d -p 8080:8080 --name apa-agent-ci-${{ matrix.goarch }} apa:ci-${{ matrix.goarch }}
      - name: Health check
        run: |
          for i in $(seq 1 10); do
            curl http://localhost:8080/admin/health && break
            sleep 5
          done
