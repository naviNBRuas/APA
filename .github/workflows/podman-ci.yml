name: Podman CI

# This workflow builds and runs the agent in a Podman container.
# The Go tests are run in the main CI workflow (ci.yml).

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Build WASM modules
        run: |
          MODULES=(config-watcher crypto-hasher data-logger message-broker net-monitor simple-adder system-info)
          for module in "${MODULES[@]}"; do
            echo "Building WASM module: $module"
            GOOS=wasip1 GOARCH=wasm go build -o examples/modules/$module/$module.wasm examples/modules/$module/main.go
          done
      - name: Set up Podman
        run: sudo apt-get update && sudo apt-get install -y podman
      - name: Build APA image with cross-compilation
        run: |
          # Extract OS and ARCH from platform
          OS=$(echo ${{ matrix.platform }} | cut -d'/' -f1)
          ARCH=$(echo ${{ matrix.platform }} | cut -d'/' -f2)
          podman build --platform ${{ matrix.platform }} -t apa:ci-${OS}-${ARCH} -f Containerfile .
      - name: Run APA container
        run: |
          OS=$(echo ${{ matrix.platform }} | cut -d'/' -f1)
          ARCH=$(echo ${{ matrix.platform }} | cut -d'/' -f2)
          podman run --rm -d -p 8080:8080 --name apa-agent-ci-${OS}-${ARCH} apa:ci-${OS}-${ARCH}
      - name: Health check
        run: |
          for i in $(seq 1 10); do
            curl http://localhost:8080/admin/health && break
            sleep 5
          done