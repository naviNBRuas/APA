name: CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
          - goos: darwin
            goarch: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ matrix.goarch == 'arm64' }}
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Clean Go build cache
        run: go clean -cache
      - name: Build WASM modules
        run: |
          MODULES=(config-watcher crypto-hasher data-logger message-broker net-monitor simple-adder system-info)
          for module in "${MODULES[@]}"; do
            echo "Building WASM module: $module"
            GOOS=wasip1 GOARCH=wasm go build -o examples/modules/$module/$module.wasm examples/modules/$module/main.go
          done
      - name: Test
        run: go list ./... | grep -v /examples/modules | xargs go test -v

  build:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
          - goos: darwin
            goarch: arm64
          - goos: darwin
            goarch: 386
          - goos: linux
            goarch: 386
          - goos: windows
            goarch: 386

    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ matrix.goarch == 'arm64' }}
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Clean Go build cache
        run: go clean -cache
      - name: Build
        run: |
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
            go build -v -ldflags="-s -w" -o build/agentd-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/agentd
      - name: Archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: agentbinaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/

  container-build:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push container image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          platforms: ${{ matrix.platform }}
          tags: apa:latest-${{ matrix.platform }}
          outputs: type=docker,dest=/tmp/apa-image-${{ matrix.platform }}.tar
      - name: Upload container image
        uses: actions/upload-artifact@v4
        with:
          name: container-image-${{ matrix.platform }}
          path: /tmp/apa-image-${{ matrix.platform }}.tar

  # New job for packaging deployment artifacts
  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: build
      - name: Flatten build directory structure
        run: |
          # Move all binaries to the main build directory
          find build -name "agentbinaries-*" -type d -exec sh -c 'mv "$1"/* build/ 2>/dev/null || true' _ {} \;
          # Move modules to the main build directory
          find build -name "modules-*" -type d -exec mv {} build/ \;
          ls -la build/
      - name: Install packaging dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm dpkg-dev
      - name: Run packaging script
        run: |
          chmod +x scripts/packaging/package.sh
          scripts/packaging/package.sh
      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-packages
          path: dist/

  # New job for creating releases when tagging
  release:
    needs: [test, build, container-build, package]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Flatten artifacts directory structure
        run: |
          # Move all artifacts to a single directory
          mkdir -p release-artifacts
          find artifacts -type f -exec mv {} release-artifacts/ \;
          ls -la release-artifacts/
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}